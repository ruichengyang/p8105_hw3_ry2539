---
title: "Simple document"
output: html_document
---

I'm an R Markdown document! 

# Section 1

Here's a **code chunk** that samples from 
a _normal distribution_:

```{r}
library(tidyverse)
library(ggridges)
library(patchwork)
library(kableExtra)

library(p8105.datasets)
data("instacart")

view(instacart)

instacart %>% count(aisle, sort = TRUE)
```

There are about `r length(unique(instacart$aisle_id))`aisles in total. The aisle with the most amount of items ordered would be fresh vegetables.

```{r}

instacart |> count(aisle, sort = TRUE) |> filter(n > 10000) |>
  mutate(aisle = reorder(aisle, n)) |> ggplot(aes(x = n, y = aisle)) +
  geom_col() +  labs(x = "Total Number of Items Ordered", y = "Aisle")

```



```{r}

instacart |> filter(aisle == "packaged vegetables fruits" | aisle == "dog food care" |
                      aisle == "baking ingredients") |> 
                      count(aisle, product_name, sort = TRUE) |> group_by(aisle) |>
                      slice_max(order_by = n, n = 3) |>
                      arrange(aisle, n) |>
                      mutate(`Number of Times Ordered` = n) |>
                      select(-n)

```
Among the three aisles, dog food care has the least amount of items ordered from it. This can be explained by how only a portion of customers own pets--and only a portion own dogs--and thus a smaller proportion of customers would need dog food. With that said, the most popular item in this aisle is Snack Sticks Chicken & Rice Recipe Dog Treats.

Meanwhile, packaged vegetable fruits is the most popular aisle due to how such items do not need further preparation to eat, as opposed to baking ingredients that require work on the customers. The most popular item from this aisle is organic baby spinach. This could be because organic baby spinach can be eaten raw and cooked, giving it more variety. It is also interesting to note that customers seem to prefer raspberries to blueberries.

Finally, among baking ingredients, customer seem to prefer light brown sugar compared to cane sugar. This could be due to how light brown sugar is refined and could give a richer flavor compared to cane sugar.


```{r}

instacart |> filter(product_name == "Pink Lady Apples" | product_name == "Coffee Ice Cream") |> mutate(order_dow = case_when(
            order_dow == 0 ~ "Sunday",
            order_dow == 1 ~ "Monday",
            order_dow == 2 ~ "Tuesday",
            order_dow == 3 ~ "Wednesday",
            order_dow == 4 ~ "Thursday",
            order_dow == 5 ~ "Friday",
            order_dow == 6 ~ "Saturday",
          )) |> group_by(product_name, order_dow) |>
          summarize(mean_hour = mean(order_hour_of_day)) |>
          pivot_wider(
            names_from = order_dow,
            values_from = mean_hour
          )

```

Both products seem to be ordered around the afternoon on Friday, Sunday, and Wednesday. However, aside from Friday when Pink Lady Apples is ordered after Coffee Ice Cream, Pink Lady Apples is ordered before Coffee Ice Cream on Sunday and Wednesday. On every other day, while Coffee Ice Cream is still ordered around the afternoon, Pink Lady Apples is ordered around late morning before the noon. This could be because Pink Lady Apples is a fruit and would be in popular demand. Therefore, customers would likely want to order such an item as early as possible. Meanwhile, Coffee Ice Cream would be suited to when the day is hot, which is likely to happen in the afternoon.

# Section 2

```{r}

#Read the zillow rental price data file#

zillow_price_df = read_csv("./zillow_data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv")

#Have a new data variable as ZipCode from the regionname variable#

zillow_price_zip_variation_df = mutate(zillow_price_df, ZipCode = RegionName)

#Clean the data and eliminate StateName, RegionName, RegionType, which are unnecessary data variables#

zillow_clean_price_df = select(zillow_price_zip_variation_df, -`StateName`, -RegionName, -RegionType)
```

```{r}

#Read the zillow properties data file#

zillow_df = read_csv("./zillow_data/zillow_data/Zip Codes.csv")

#Mutate the CountyName variable from "Bronx" to "Bronx County"#

zillow_county_variation_df = mutate(zillow_df, CountyName = paste(County, "County"))

#Eliminate varibles such as State FIPS, County FIPS, and County#

zillow_clean_df = select(zillow_county_variation_df, -`State FIPS`, -`County FIPS`, -County)
```

```{r}

#Merge the two datasets into a single tidy dataset#

first_single_zillow_df = left_join(zillow_clean_df, zillow_clean_price_df)
first_clean_single_zillow_df = arrange(first_single_zillow_df, RegionID)

#Count the unique zip codes and neighborhoods present in this dataset#

pivot_longer_single_zillow_df = pivot_longer(
  first_clean_single_zillow_df, cols = starts_with("20"),
  names_to = "Date",
  values_to = "Rental Price"
)

not_na_pivot_longer_zillow_df = pivot_longer_single_zillow_df %>% drop_na(`Rental Price`)
is_na_pivot_longer_zillow_df = pivot_longer_single_zillow_df %>% filter(is.na(`Rental Price`))

not_na_pivot_longer_single_zillow_df = 
  not_na_pivot_longer_zillow_df |> count(ZipCode, sort = TRUE)

is_na_pivot_longer_single_zillow_df =
  is_na_pivot_longer_zillow_df |> count(ZipCode, sort = TRUE)

is_na_pivot_longer_single_zillow_df = is_na_pivot_longer_single_zillow_df %>% mutate(n = 0)

combined_zip_code_rental_count_df = bind_rows(is_na_pivot_longer_single_zillow_df, not_na_pivot_longer_single_zillow_df)

counts_of_zip_codes = combined_zip_code_rental_count_df %>% group_by(ZipCode) %>%
  summarise(n = sum(n))

highest_counts_of_zip_codes = counts_of_zip_codes %>% filter(n == 116)
lowest_counts_of_zip_codes = counts_of_zip_codes %>% filter(n < 10) %>% arrange(desc(n))

```

The number of ZIP codes that were observed for all 116 months is `r sum(counts_of_zip_codes$n == 116)`. Meanwhile, the number of ZIP codes that were observed for fewer than 10 months is `r sum(counts_of_zip_codes$n < 10)`. A lot of the zip codes that were observed rarely are located in areas of NYC that host a lot of business. Therefore, these properties would likely not have rental prices, as these buildings would already be occupied for various companies. Meanwhile, other zip codes that are observed each month take place in locations such as upper Manhattan and Brooklyn, where residential buildings would be more concentrated in.

```{r}

Year_pivot_longer_df = separate(pivot_longer_single_zillow_df, 
                                Date, into = c("Year", "Month", "Day"), sep = "-")

Year_1_pivot_longer_df = Year_pivot_longer_df |> mutate(Year = strtoi(Year), `Rental Price` =
                                                        case_when(
                                                          is.na(`Rental Price`) ~ 0,
                                                          !is.na(`Rental Price`) ~ (`Rental Price`)
                                                        ))

Year_Borough_df = Year_1_pivot_longer_df |> drop_na(`Rental Price`) |> group_by(Year, CountyName) |>
  summarize(mean_rental_price = mean(`Rental Price`)) |> arrange(CountyName)

kable(Year_Borough_df, format = "html", col.names = c("Year", "County Name", "Mean Rental Price"))

ggplot(Year_Borough_df, aes(x = Year, y = mean_rental_price)) + geom_point(aes(color = CountyName)) +
  geom_smooth(se = FALSE) + facet_grid(.~CountyName)


```

In each of the boroughs, it seems like the mean rental price increases from 2015 to 2024. It is important to note that the mean rental price for Richmond county has a mean value of 0 from 2015 to 2019 because there were no observations of the rental price for those zip codes. For New York County from 2019 to 2020, there seems to be a time when the rental price stayed relatively unchanged or even decreased. This would make sense, as 2020 was the start of the pandemic and therefore the demand for properties would have decreased, decreasing the mean rental price for that year.

Comparing the trends across all boroughs, it seems that the mean rental price for Kings County a.k.a. Brooklyn is the highest. This would be due to the demand for residential buildings there being much higher than all other boroughs. Meanwhile, there is a sharp increase in the mean rental price in Bronx county from 2021 to 2024, with the mean rental price in Bronx County being higher than New York County in 2024.

The mean rental price for New York County is generally higher than Queens County. Rather than a high demand, this could be attributed to how the supply of properties for rent is much lower than that in Queens County. This could also be applied to Richmond County to explain why there is also a sharp increase in the mean rental price from 2020 to 2024.


```{r}

Zip_Code_Rent_Year_df = Year_pivot_longer_df |> mutate(Year = strtoi(Year))
  
Zip_Code_Rent_df = Zip_Code_Rent_Year_df |> group_by(Year, ZipCode, CountyName, Month) |> summarize(rental_price = `Rental Price`)

Zip_Code_Rent_df = Zip_Code_Rent_df %>% drop_na(rental_price)

Zip_Code_Rent_df = Zip_Code_Rent_df %>% mutate(Date = paste(as.character(Year), as.character(Month), sep = "-"))

every_rent_zip_code = ggplot(Zip_Code_Rent_df, aes(x = Date, y = rental_price)) + geom_point(aes(color = ZipCode)) + facet_wrap(~CountyName)

every_rent_zip_code

p = ggplot(Zip_Code_Rent_df, aes(x = Date, y = rental_price)) + geom_point(aes(color = CountyName)) + facet_wrap(~ZipCode)

ggsave("Results/zip_codes_borough.png", plot = p, width = 30, height = 20, limitsize = FALSE)


```

After filtering out the zip codes and properties that were missing values for rental prices, we observe the same trend of all properties across boroughs increasing. The lack of data for earlier dates in Richmond County could be attributed to how Staten Island may have had properties that lacked tenants. It is also notable that with properties in New York County, there was a sharp decrease in the rental price among many zip codes from the year 2019 to 2020. Again, this could be attributed to the COVID-19 pandemic.

```{r}

Twenty_Twenty_Three_Zip_Code_rent_df = Zip_Code_Rent_Year_df |> filter(Year == 2023) |> group_by(ZipCode, CountyName) |>  summarize(mean_rental_price = mean(`Rental Price`)) |> drop_na(mean_rental_price)

Twenty_Twenty_Three_Zip_Code_rent_df

ggplot(Twenty_Twenty_Three_Zip_Code_rent_df, aes(x = ZipCode, y = mean_rental_price)) + geom_point(aes(color = CountyName))

```

For the zip codes in New York County in 2023, the mean rental price has a much larger dispersion compared to other boroughs. Specifically, it has a couple of data points that have a mean rental price larger than 6,000 dollars per month. Overall, it seems like New York County has a higher mean rental price in 2023 compared to other boroughs.

The second highest mean rental price belongs to Kings County, which lines up with the trend observed for other years. It is interesting to see that the properties that do have rental prices in New York County has a higher mean rental price than Kings County. However, because there are many more properties in New York County that lacks data on rental price, the mean rental price for New York County as a whole is generally lower than that of Kings County.

Finally, the mean rental price over 2023 for Bronx County, Richmond County, and Queens County is overall similar. It is notable that even in 2023, Richmond County has significantly less observations compared to all other boroughs.

```{r}

mean_rent_zip_code_2023_plot = ggplot(Twenty_Twenty_Three_Zip_Code_rent_df, aes(x = ZipCode, y = mean_rental_price)) + geom_point(aes(color = CountyName))

combined_plot = every_rent_zip_code/mean_rent_zip_code_2023_plot

ggsave("Results/nyc_combined_rental_trend.png", plot = combined_plot, width = 30, height = 20, limitsize = FALSE)

```

# Section 3

```{r}

nhane_covar_df = read_csv("./Problem_3_Datasets/nhanes_covar.csv")
nhane_accel_df = read_csv("./Problem_3_Datasets/nhanes_accel.csv")

nhane_covar_clean_variable_df = nhane_covar_df |> mutate(SEQN = `...1`, sex = `1 = male`,
                                                      age = `...3`, BMI = `...4`, 
                                                      education = `1 = Less than high school`) |>
  select(-`...1`, -`1 = male`, -`...3`, -`...4`, -`1 = Less than high school`) |> drop_na(SEQN, sex, age, BMI, education) |> filter(age >= 21) |> filter(SEQN != "SEQN") |> mutate(
    sex = case_when(
      sex == 1 ~ "male",
      sex == 2 ~ "female"
    ),
    education = case_when(
      education == 1 ~ "Less than high school",
      education == 2 ~ "High school equivalent",
      education == 3 ~ "More than high school"
    ),
    SEQN = as.numeric(SEQN), age = as.numeric(age), BMI = as.numeric(BMI)
  )

full_nhane_joint_data_df = left_join(nhane_covar_clean_variable_df, nhane_accel_df)

```

```{r}
table_sex_education_distribution = full_nhane_joint_data_df |> group_by(sex, education) |>
  summarise(n = n()) |> pivot_wider(names_from = sex, values_from = n)

kable(table_sex_education_distribution, format = "html", col.names = c("Education", "Female", "Male"))
```

```{r}

ggplot(full_nhane_joint_data_df, aes(x = age, fill = sex)) + geom_histogram(binwidth = 4, alpha = 0.5) +
  facet_grid(education~sex)

```

For the participants with more than high school education, the distribution of ages is skewed right for female participants compared to male participants. This could be because how higher education was historically dominated by male students and only relatively recently is education being implemented more broadly across all sexes. 

Meanwhile, the distribution of ages for less than high school education is relatively concentrated around ages 45, 70,and 80 for male participants, while the distribution for female participants in the same education level is more uniform. The distribution for male participants can be explained by how older participants may have come from a time when people had less resources to study and attend higher education. Overall, the total number of participants with this education level is similar for both sexes.

Finally, the distribution of ages for an education of high school equivalent is relatively uniform for both sexes. However, from the table, we see that the total number of male participants are much higher than female participants in this education level.

```{r}

total_MIMS_df = full_nhane_joint_data_df |> pivot_longer(cols = starts_with("min"), 
                                                        names_to = "MIMS", values_to = "MIMS amount") |>
  group_by(SEQN, sex, age, education) |> summarise(Total_MIMS = sum(`MIMS amount`))

ggplot(total_MIMS_df, aes(x = age, y = Total_MIMS, color = sex)) + geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) + facet_grid(education~sex)

```

For education levels, the total MIMS has an overall negative correlation with age. For less than high school education, the total MIMS for all ages is rather consistent between the sexes. However, for high school equivalent education, there is an actual increase in total MIMS from ages 20 to 40 for both male and female participants. The total MIMS for female participants around age 40 is also significantly higher than male participants. Finally, for more than high school education, the total MIMS for female participants is higher than male participants by a bit for all ages.

```{r}

time_minute_average_df = full_nhane_joint_data_df |> pivot_longer(cols = starts_with("min"), 
                                                        names_to = "MIMS", values_to = "MIMS amount") |>
  mutate(minute = as.numeric(str_extract(MIMS, "\\d+")), hour = minute %/% 60) |> group_by(hour, sex, education) |> summarise(Mean_MIMS = mean(`MIMS amount`))

ggplot(time_minute_average_df, aes(x = hour, y = Mean_MIMS, color = sex)) + geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) + facet_wrap(~education)

```

Overall, it seems that the mean MIMS increases from midnight to around noon of the day, and then decreases from noon to midnight. The more notable differences can be observed between the sexes. For less than high school education, the mean MIMS is similar for both female and male participants. However, for high school equivalent and higher education, the mean MIMS is higher for female participants over male participants.

For higher than high school education, the mean MIMS for female participants is much higher than male participants around the hours of 10 to 20. The same trend can be observed for high school equivalent education, although the discrepancy between the sexes is much smaller. For other hours, the mean MIMS of female participants are only higher than male participants by a percentage at most. Otherwise, the mean MIMS difference is rather insignificant between the sexes.